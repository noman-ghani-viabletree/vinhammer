<?php/** * Extra Functions file * * @package Ultimate WooCommerce Auction PRO business - Addon stripe auto debit * @author Nitesh Singh  * @since 1.0 *  */if ( ! defined( 'ABSPATH' ) ) {	exit;}add_filter('ultimate_woocommerce_auction_before_place_bid_filter',	'uwa_stripe_credit_cart_checking', 5, 3);function uwa_stripe_credit_cart_checking($product_data, $bid){    global $woocommerce, $product_data;	$saved_methods = wc_get_customer_saved_methods_list( get_current_user_id() );	$payment_method_url = wc_get_account_endpoint_url('payment-methods');	$has_methods   = (bool) $saved_methods;	if($has_methods){		return true;	} 	else {		wc_add_notice(sprintf(__('Please enter your credit card details before placing the bid. <a href="%s" class="button" target="_blank">Submit here &rarr;</a>', 'woo_ua'), $payment_method_url), 'error');		return false;	}}/*function uwa_get_stripe_buyer_premium_value($winner_bid){         $uwa_buyer_price = 0;        $uwa_bpm_type = get_option('uwa_buyers_premium_type');        $uwa_bpm_amt = get_option('uwa_buyers_premium_rate');        if(isset($uwa_bpm_amt) && !empty($uwa_bpm_amt)){            if(isset($uwa_bpm_type) && !empty($uwa_bpm_type)){                if($uwa_bpm_type == 'percentage'){                    $uwa_buyer_price = ($winner_bid * $uwa_bpm_amt)/100;                    /* calculations for min max buyers premium                     $uwa_bpm_min_val = get_option("uwa_buyers_min_premium", "");                	$uwa_bpm_max_val = get_option("uwa_buyers_max_premium", "");                	$min_val = $uwa_bpm_min_val;					$max_val = $uwa_bpm_max_val;										if($min_val > 0 ){						if($uwa_buyer_price < $min_val ){							$uwa_buyer_price = $min_val;						}					}					if($max_val > 0 ){						if($uwa_buyer_price > $max_val ){							$uwa_buyer_price = $max_val;						}					}                }                else{                    $uwa_buyer_price = $uwa_bpm_amt;                }            }        }   	return $uwa_buyer_price;   }*/function uwa_get_stripe_buyer_premium_value($product_id, $winner_bid){        $uwa_buyer_price = 0;        if($product_id > 0){        	$level = get_post_meta($product_id, 'woo_ua_buyer_level', true);        	if($level == "product_level"){        		/* set buyers premium at product level */					$uwa_bpm_type = get_post_meta($product_id, 'woo_ua_buyer_type', true);			        $uwa_bpm_amt = get_post_meta($product_id, 'woo_ua_buyer_fee_amt', true);			        if(isset($uwa_bpm_amt) && !empty($uwa_bpm_amt)){			            if(isset($uwa_bpm_type) && !empty($uwa_bpm_type)){			                if($uwa_bpm_type == 'percentage'){			                    $uwa_buyer_price = ($winner_bid * $uwa_bpm_amt)/100;			                    /* calculations for min max buyers premium */			                    $uwa_bpm_min_val = get_post_meta($product_id, 'woo_ua_buyer_min_amt', true);			                	$uwa_bpm_max_val = get_post_meta($product_id, 'woo_ua_buyer_max_amt', true);			                	$min_val = $uwa_bpm_min_val;								$max_val = $uwa_bpm_max_val;																if($min_val > 0 ){									if($uwa_buyer_price < $min_val ){										$uwa_buyer_price = $min_val;									}								}								if($max_val > 0 ){									if($uwa_buyer_price > $max_val ){										$uwa_buyer_price = $max_val;									}								}			                }			                else{			                    $uwa_buyer_price = $uwa_bpm_amt;			                }			            }			        } /* end of if - isset */        	}        	else{        		/* set buyers premium globally */			 		$uwa_bpm_type = get_option('uwa_buyers_premium_type');			        $uwa_bpm_amt = get_option('uwa_buyers_premium_rate');			        if(isset($uwa_bpm_amt) && !empty($uwa_bpm_amt)){			            if(isset($uwa_bpm_type) && !empty($uwa_bpm_type)){			                if($uwa_bpm_type == 'percentage'){			                    $uwa_buyer_price = ($winner_bid * $uwa_bpm_amt)/100;			                    /* calculations for min max buyers premium */			                    $uwa_bpm_min_val = get_option("uwa_buyers_min_premium", "");			                	$uwa_bpm_max_val = get_option("uwa_buyers_max_premium", "");			                	$min_val = $uwa_bpm_min_val;								$max_val = $uwa_bpm_max_val;																if($min_val > 0 ){									if($uwa_buyer_price < $min_val ){										$uwa_buyer_price = $min_val;									}								}								if($max_val > 0 ){									if($uwa_buyer_price > $max_val ){										$uwa_buyer_price = $max_val;									}								}			                }			                else{			                    $uwa_buyer_price = $uwa_bpm_amt;			                }			            }			        } /* end of if - isset */        	} /* end of else - globally */        	        } /* end of if - productid */          	return $uwa_buyer_price;   }function uwa_get_stripe_auto_debit_value($stripe_amt){     global $wpdb;	   $uwa_product_price = 0;	   $uwa_stripe_charge_type = get_option('uwa_stripe_charge_type');	   if($uwa_stripe_charge_type == "uwa_stripe_charge_type_partially"){			$uwa_partially_type = get_option('uwa_stripe_charge_type_partially_type');			$uwa_partially_amt = get_option('uwa_stripe_charge_type_partially_amt');			if(isset($uwa_partially_amt) && !empty($uwa_partially_amt)){				if(isset($uwa_partially_type) && !empty($uwa_partially_type)){					if($uwa_partially_type == 'percentage'){						$uwa_product_price = ($stripe_amt * $uwa_partially_amt)/100;					}					else{						$uwa_product_price = $uwa_partially_amt;                                        }				}			}					}		elseif($uwa_stripe_charge_type == "uwa_stripe_charge_type_full"){			$uwa_product_price = $stripe_amt;		}		else {			$uwa_product_price = 0;		}				return $uwa_product_price;}/* check post author */function uwa_stripe_addon_is_vendor_product( $auction_post_author = '') {		 	$auction_post_author_data = new WP_User( $auction_post_author );	if(in_array('wcfm_vendor', $auction_post_author_data->roles)){		return true; 	}	else {		return false;	}	}function uwa_get_stripe_auto_debit_admin_commission($winner_bid_amt){         global $wpdb, $WCFM, $WCFMmp;		$commission_amount = 0;				$wcfm_commission_options = get_option( 'wcfm_commission_options', array() );		$vendor_commission_for = $wcfm_commission_options['commission_for'];		$commission_percent = $wcfm_commission_options['commission_percent'];		$commission_fixed = $wcfm_commission_options['commission_fixed'];				$commission_mode = $wcfm_commission_options['commission_mode'];	     	//percent   fixed   percent_fixed		if($commission_mode == 'percent'){			$commission_amount = ($winner_bid_amt * $commission_percent)/100;		} 		elseif($commission_mode == 'fixed') {			$commission_amount = $commission_fixed;		}		elseif($commission_mode == 'percent_fixed') {						   $commission_amount1 = ($winner_bid_amt * $commission_percent)/100;			   $commission_amount2 = $commission_fixed;			   $commission_amount = $commission_amount1 +  $commission_amount2;			}				if($vendor_commission_for == 'admin') {			$commission_amount = $commission_amount;		}		else {			$commission_amount = $winner_bid_amt - $commission_amount;		}					return $commission_amount;}	function uwa_get_stripe_auto_debit_value_vendor($stripe_amt_vendor){ 		global $wpdb;	  		$uwa_product_price_vendor = 0;  		$uwa_stripe_charge_type_vendor = get_option('uwa_stripe_charge_type');		if($uwa_stripe_charge_type_vendor == "uwa_stripe_charge_type_partially"){						$uwa_partially_type_vendor = get_option(				'uwa_stripe_charge_type_partially_type');			$uwa_partially_amt_vendor = get_option(				'uwa_stripe_charge_type_partially_amt');						if(isset($uwa_partially_type_vendor) && !empty($uwa_partially_type_vendor)){				if(isset($uwa_partially_amt_vendor) && !empty($uwa_partially_amt_vendor)){									if($uwa_partially_type_vendor == 'percentage'){						$uwa_product_price_vendor = ($stripe_amt_vendor * 							$uwa_partially_amt_vendor)/100;					   					} 					else{						$uwa_product_price_vendor = $uwa_partially_amt_vendor;					}				}			}		} 		elseif($uwa_stripe_charge_type_vendor == "uwa_stripe_charge_type_full"){			$uwa_product_price_vendor = $stripe_amt_vendor;  		} 		else {			$uwa_product_price_vendor = 0;		}		return $uwa_product_price_vendor;}/*add_action( 'ultimate_woocommerce_auction_close','uwa_stripe_addon_get_winner_info_cut_payment'); */add_action( 'ultimate_woocommerce_auction_autodabit_payment','uwa_stripe_addon_get_winner_info_cut_payment'); function uwa_stripe_addon_get_winner_info_cut_payment( $auction_id ) {			global $wpdb,$woocommerce, $post,$WCFM;				/* For one time auto dabit call */		$auto_debit_one_time_payment = get_post_meta( $auction_id, '_done_one_time_payment', true );				$auto_debit_status = get_post_meta( $auction_id, '_uwa_stripe_auto_debit_status', true );				if($auto_debit_one_time_payment!='done_one_time_payment_1'){ 			add_post_meta($auction_id, '_done_one_time_payment','done_one_time_payment_0');		}		if($auto_debit_status !="paid"){			if($auto_debit_one_time_payment !="done_one_time_payment_1" ){							$product = wc_get_product($auction_id);						$cuserid = $product->get_uwa_auction_current_bider();			$expired_auct = $product->get_uwa_auction_expired();								$saved_methods = wc_get_customer_saved_methods_list( $cuserid );			$has_methods   = (bool) $saved_methods;			if($has_methods){							if ( !empty($cuserid) &&  $expired_auct == '2'  ) {					$product_id =  $product->get_id();									$winning_bid_amt = $product->get_uwa_auction_current_bid();						$get_charged_for_winner = get_option(						"_uwa_w_s_charge_".$product_id."_".$cuserid, false);					if(empty($get_charged_for_winner)){						add_option("_uwa_w_s_charge_".$product_id."_".$cuserid, "added");					} 					else {						update_option("_uwa_w_s_charge_".$product_id."_".$cuserid, "added");					}						$auction_post_author = get_post_field( 'post_author', $product_id );							$wcfm_withdrawal_options = get_option( 'wcfm_withdrawal_options', array());						$withdrawal_payment_methods = $wcfm_withdrawal_options['payment_methods'];					$vendor_stripe_id = get_user_meta($auction_post_author, 						'stripe_user_id', true );					$set = "";					if(is_array($withdrawal_payment_methods)) {						if(in_array("stripe_split", $withdrawal_payment_methods) && 							!empty($vendor_stripe_id)){							$set = "yes";						}					}							$vendor_product = uwa_stripe_addon_is_vendor_product( $auction_post_author );									if($vendor_product && $set == "yes"){						/* vendor auto debit */							$uwa_price_vendor = 0;										$total_amt = uwa_get_stripe_auto_debit_value_vendor($winning_bid_amt);						$uwa_price_vendor = uwa_get_stripe_auto_debit_value_vendor(							$winning_bid_amt);						$uwa_admin_commission = $uwa_price_vendor;											$uwa_admin_commission = uwa_get_stripe_auto_debit_admin_commission(							$uwa_price_vendor);																		/* buyers_premium */											$uwa_stripe_buyers_premium_enable_vendor = get_option(							'uwa_stripe_buyers_premium_enable');											if($uwa_stripe_buyers_premium_enable_vendor == "yes"){							$uwa_buyers_price_vendor  = uwa_get_stripe_buyer_premium_value($product_id,								$winning_bid_amt);							/*$uwa_buyers_premium_for = get_option('uwa_buyers_premium_for', 								"uwa_admin");*/							$all_data = uwa_get_buyer_premium_data($product_id);							$bpm_givento = $all_data['bpm_givento'];							$uwa_buyers_premium_for = $bpm_givento;							/* buyers_premium for vendor */									if($uwa_buyers_premium_for=="uwa_owners"){								$uwa_price_vendor = $uwa_price_vendor + $uwa_buyers_price_vendor;							} 							else {															$uwa_admin_commission = $uwa_admin_commission + 									$uwa_buyers_price_vendor;															}							$total_amt = $total_amt + $uwa_buyers_price_vendor;						} /* end of if - enable_vendor */														$paid_tobe_vendor = 0;											$paid_tobe_vendor = $total_amt - $uwa_admin_commission;													//this amount to paid vendor						$vendor_amt = $paid_tobe_vendor;															if(!empty($total_amt) && $total_amt > 0) {														$total_amt = wc_format_decimal($total_amt,2);								$vendor_amt = wc_format_decimal($paid_tobe_vendor,2);										$get_charged_for_winner = get_option(								"_uwa_w_s_charge_".$product_id."_".$cuserid, false);														if($get_charged_for_winner == "added"){												// payment is pending.. make payment																				if($total_amt > 0){									require_once ( UW_AUCTION_PRO_ADDONS .'stripe_auto_debit/lib/uwa-stripe/stripe-main.php' );																		uwa_winner_make_strip_payment_vendor($cuserid, $vendor_amt, 										$total_amt, $product_id, $uwa_price_vendor, 										$uwa_buyers_price_vendor, $vendor_stripe_id);																}							}							} /* end of if - empty total amt */												} /* end of if - vendor product */					else{  												$w_product_price = 0;						$uwa_stripe_product_price = 0;						$uwa_stripe_product_price = uwa_get_stripe_auto_debit_value(							$winning_bid_amt);						$w_product_price = uwa_get_stripe_auto_debit_value($winning_bid_amt);												$uwa_stripe_buyers_premium_enable = get_option(							'uwa_stripe_buyers_premium_enable');						$uwa_stripe_buyer_price = 0;						if($uwa_stripe_buyers_premium_enable == "yes"){								$uwa_stripe_buyer_price  = uwa_get_stripe_buyer_premium_value($product_id,								$winning_bid_amt);							$w_product_price = $w_product_price + $uwa_stripe_buyer_price;						}						if(!empty($w_product_price) && $w_product_price > 0) {								$total_amt = wc_format_decimal($w_product_price,2);								$get_charged_for_winner = get_option(									"_uwa_w_s_charge_".$product_id."_".$cuserid, false);								//if($get_charged_for_winner == false){								if($get_charged_for_winner == "added"){									// if payment is pending.. make payment																				if($total_amt > 0){																			require_once (UW_AUCTION_PRO_ADDONS .											'stripe_auto_debit/lib/uwa-stripe/stripe-main.php');																					uwa_winner_make_strip_payment($cuserid, $total_amt, 											$product_id, $uwa_stripe_product_price, 											$uwa_stripe_buyer_price);									}								}																} /* end of if - product price > 0 */ 														} /* end of else */									} /* end of if - empty $cuserid */													} /* end of if - has methods */				else {					uwa_create_log("Auto Debit this user have no saved payment method : UserID#".$cuserid);				}			} 		}	 	else {						uwa_create_log("Auto Debit All ready Done For this Product : ProductID#".$auction_id);	 	} /* end of if - has Paid Status */		}